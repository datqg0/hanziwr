<!DOCTYPE html>
<html lang="vi">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GKT0DLRM43"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-GKT0DLRM43');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Writer Practice
    </title>

    <script src="hanzi-writer.min.js"></script>

    <style>
        body {
            margin: 0;
            background: #111;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #game-container {
            position: relative;
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-sizing: border-box;
        }

        #hp-bar-container {
            width: 80%;
            height: 20px;
            background: #444;
            margin: 20px auto;
            border-radius: 10px;
        }

        #hp-bar {
            height: 100%;
            width: 100%;
            background: limegreen;
            border-radius: 10px;
            transition: width 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: black;
            position: relative;
        }

        #character-target {
            margin: 15px auto;
            width: 380px;
            height: 380px;
            background: white;
            border-radius: 10px;
        }

        #character-target-1 {
            margin: 15px auto;
            width: 300px;
            height: 300px;
            background: white;
            border-radius: 10px;
        }

        #status {
            margin-top: 30px;
            font-size: 18px;
        }

        #hud {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 10px auto;
            width: 80%;
            font-size: 20px;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        .score-value {
            color: white;
            margin-left: 5px;
        }

        /* Overlays */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .menu-btn {
            background: #ffcc00;
            color: black;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s, background 0.2s;
        }

        .menu-btn:hover {
            transform: scale(1.1);
            background: #ffe066;
        }

        .secondary-btn {
            background: transparent;
            color: #ffcc00;
            border: 2px solid #ffcc00;
            padding: 10px 30px;
            font-size: 18px;
            border-radius: 20px;
            cursor: pointer;
            margin: 10px;
            text-decoration: none;
        }

        input[type="text"] {
            padding: 12px;
            font-size: 18px;
            border-radius: 10px;
            border: none;
            margin: 20px;
            width: 250px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }

            h1 {
                font-size: 18px;
                margin: 5px 0;
                flex-shrink: 0;
            }

            #game-container {
                height: 100vh;
                padding: 5px 0;
                overflow: hidden;
                box-sizing: border-box;
            }

            #hp-bar-container {
                width: 85%;
                height: 12px;
                margin: 5px auto;
                flex-shrink: 0;
            }

            #hud {
                width: 85%;
                margin: 4px auto;
                padding: 5px;
                flex-direction: row;
                gap: 5px;
                font-size: 13px;
                flex-shrink: 0;
            }

            #character-target,
            #character-target-1 {
                margin: 4px auto;
                width: 80vw;
                height: 80vw;
                max-width: 380px;
                max-height: 380px;
                flex-grow: 1;
                flex-shrink: 1;
                min-height: 100px;
            }

            #status {
                margin-top: 3px;
                margin-bottom: 5px;
                font-size: 12px;
                flex-shrink: 0;
            }

            .menu-btn {
                padding: 12px 30px;
                font-size: 18px;
                margin: 8px;
            }

            .secondary-btn {
                padding: 8px 20px;
                font-size: 14px;
                margin: 8px;
            }

            input[type="text"] {
                width: 200px;
                padding: 10px;
                font-size: 16px;
                margin: 10px;
            }

            #final-score-display {
                font-size: 18px !important;
            }

            .overlay>div {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 16px;
                margin: 3px 0;
                flex-shrink: 0;
            }

            #hp-bar-container {
                width: 90%;
                height: 10px;
                margin: 3px auto;
                flex-shrink: 0;
            }

            #hud {
                width: 90%;
                font-size: 12px;
                padding: 4px;
                gap: 4px;
                flex-shrink: 0;
            }

            #character-target,
            #character-target-1 {
                width: 85vw;
                height: 85vw;
                max-width: 300px;
                max-height: 300px;
                margin: 3px auto;
                flex-grow: 1;
                flex-shrink: 1;
                min-height: 80px;
            }

            #status {
                font-size: 10px;
                margin: 2px 0 3px 0;
                flex-shrink: 0;
            }

            .menu-btn {
                padding: 10px 20px;
                font-size: 16px;
                margin: 6px;
            }

            .secondary-btn {
                padding: 8px 16px;
                font-size: 12px;
                margin: 6px;
            }

            input[type="text"] {
                width: 160px;
                padding: 8px;
                font-size: 14px;
                margin: 8px;
            }

            #game-container {
                padding: 5px 0;
            }
        }
    </style>
</head>

<body>

    <div id="game-container">
        <!-- Start Screen -->
        <div id="start-screen" class="overlay">
            <h1>Luy·ªán vi·∫øt ch·ªØ H√°n</h1>
            <button class="menu-btn" onclick="startGame()">PLAY</button>
            <a href="rank.html" class="secondary-btn">üèÜ B·∫£ng x·∫øp h·∫°ng</a>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="overlay hidden">
            <h1 style="color: #ff4444;">üíÄ GAME OVER</h1>
            <div id="final-score-display" style="font-size: 24px; margin: 10px;">Score: <span
                    class="score-value">0</span></div>
            <div style="margin-top: 20px; font-size: 18px;">Nickname:</div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <input type="text" id="player-name" placeholder="Enter your name" maxlength="20">
                <button onclick="refreshName()" title="Random Name"
                    style="background: none; border: 1px solid #ffcc00; color: #ffcc00; border-radius: 5px; cursor: pointer; padding: 10px;">üé≤</button>
            </div>
            <button id="submit-btn" class="menu-btn">Submit Score</button>
            <button class="secondary-btn" onclick="location.reload()">Back to Menu</button>
        </div>

        <h1>Luy·ªán vi·∫øt ch·ªØ H√°n</h1>

        <div id="hp-bar-container">
            <div id="hp-bar">
                <span id="hp-text">100%</span>
            </div>
        </div>

        <div id="hud">
            <div>Score: <span id="score" class="score-value">0</span></div>
            <div>High Score: <span id="high-score" class="score-value">0</span></div>
        </div>

        <div id="character-target"></div>

        <div id="character-target-1"></div>

        <div id="status"></div>

    </div>

    <script>
        let hp = 100;
        let maxHP = 100;
        let score = 0;
        let highScore = localStorage.getItem('hanzi_shooter_high_score') || 0;
        let currentChar = "Â≠¶";
        let currentCharData = null;
        let generatedPlayerName = "";
        let writer;
        let hpInterval;

        // Ch·ªØ c·ªï v≈©
        const cheeringTexts = ['N√†o chi·∫øn th√¥i!', 'B·∫°n l√†m ƒë∆∞·ª£c m√†!', 'Go go go!', 'H√£y l√™n!', 'C·ªë l√™n!', 'B·∫°n l√†m ƒë∆∞·ª£c!', 'Xu·∫•t s·∫Øc!', 'Tuy·ªát v·ªùi!', 'Keep going!', 'Crush it!', 'Easy!', 'B·∫°n ƒë·∫≥ng c·∫•p!', 'Th·∫ßn t·ªëc!', 'Si√™u nh√¢n!'];

        function getRandomCheeringText() {
            return cheeringTexts[Math.floor(Math.random() * cheeringTexts.length)];
        }

        //load dict
        let dictionary = null;
        let currentCharacters = [];
        let currentCharIndex = 0;
        async function loadDictionary() {
            try {
                //const response = await fetch('hanzi-dictionary-full.json');
                const response = await fetch('test.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();

                if (!data.characters || !Array.isArray(data.characters)) {
                    throw new Error('Invalid dictionary structure: missing or non-array characters field');
                }

                dictionary = data.characters;
                console.log(`‚úì Dictionary loaded: ${dictionary.length} characters`);
                console.log(`  Sample: ${dictionary[0].character} (${dictionary[0].pinyin}) = ${dictionary[0].english}`);
            } catch (e) {
                console.error('‚úó Dictionary load failed:', e.message);
                console.log('Using default mode');
            }
        }

        async function startGame() {
            document.getElementById("start-screen").classList.add("hidden");
            document.getElementById("game-over-screen").classList.add("hidden");
            await loadDictionary();
            hp = 100;
            maxHP = 100;
            score = 0;
            updateHP();
            updateScoreHUD();
            await spawnMonster();
            startHPDrain();
        }

        function updateScoreHUD() {
            document.getElementById("score").innerText = score;
            document.getElementById("high-score").innerText = highScore;
        }

        function addScore(points) {
            score += points;
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('hanzi_shooter_high_score', highScore);
            }
            updateScoreHUD();
        }

        async function validateWord(word) {
            const chars = word.split('');
            const validChars = [];

            for (let char of chars) {
                try {
                    await HanziWriter.loadCharacterData(char);
                    validChars.push(char);
                } catch (e) {
                    console.warn(`‚ö†Ô∏è Character "${char}" not supported`);
                }
            }

            return validChars;
        }

        function createWriterForCurrentChar(canvasSize) {
            // Clear the writing area
            document.getElementById("character-target-1").innerHTML = "";

            const currentWriteChar = currentCharacters[currentCharIndex];
            writer = HanziWriter.create('character-target-1', currentWriteChar, {
                width: canvasSize,
                height: canvasSize,
                showOutline: false,
                showCharacter: false,
                showHintAfterMisses: 3,
                highlightOnComplete: false,
                drawingWidth: 20
            });

            writer.quiz({
                onComplete: async function () {
                    currentCharIndex++;

                    if (currentCharIndex < currentCharacters.length) {
                        // Move to next character - update status and preview
                        document.getElementById("status").innerText = `üìñ Ch·ªØ ${currentCharIndex + 1}/${currentCharacters.length}`;

                        // Update highlight in preview grid
                        for (let i = 0; i < currentCharacters.length; i++) {
                            const previewDiv = document.getElementById(`char-preview-${i}`);
                            if (i === currentCharIndex) {
                                previewDiv.style.background = '#ffff99';
                                previewDiv.style.border = '3px solid #ffcc00';
                            } else if (i < currentCharIndex) {
                                previewDiv.style.background = '#ccffcc';
                                previewDiv.style.border = '2px solid #00cc00';
                            } else {
                                previewDiv.style.background = 'white';
                                previewDiv.style.border = '1px solid #ccc';
                            }
                        }

                        // Create writer for next character
                        createWriterForCurrentChar(canvasSize);
                    } else {
                        // All characters completed - move to next word
                        document.getElementById("status").innerText = `üî• ${getRandomCheeringText()}`;
                        addScore(currentCharacters.length);
                        hp = 100;
                        maxHP = 100;
                        updateHP();
                        await spawnMonster();
                    }
                },
                onMistake: function () {
                    reduceHP(5);
                }
            });
        }

        async function spawnMonster() {
            const defaultChars = [
                { character: "Â≠¶", pinyin: "xu√©", english: "study" },
                { character: "Êàò", pinyin: "zh√†n", english: "fight" },
                { character: "ÂøÉ", pinyin: "xƒ´n", english: "heart" },
                { character: "Áà±", pinyin: "√†i", english: "love" },
                { character: "Âäõ", pinyin: "l√¨", english: "strength" },
                { character: "ÁÅ´", pinyin: "hu«í", english: "fire" }
            ];

            let pool = defaultChars;
            if (dictionary && dictionary.length > 0) {
                // Determine max HSK level based on score: 0-4: HSK1, 5-9: HSK2, etc.
                const maxHSKLevel = Math.min(6, Math.floor(score / 5) + 1);

                // Inclusive filtering: include all levels from 1 to maxHSKLevel
                pool = dictionary.filter(char => {
                    if (!char.difficulty) return false;
                    const level = parseInt(char.difficulty.replace("HSK", ""));
                    return level <= maxHSKLevel;
                });

                if (pool.length === 0) pool = defaultChars;
            }

            let loaded = false;
            let retryCount = 0;
            const maxRetries = 10;

            while (!loaded && retryCount < maxRetries) {
                currentCharData = pool[Math.floor(Math.random() * pool.length)];
                currentChar = currentCharData.character;

                // Validate word by checking if all characters are supported
                const validChars = await validateWord(currentChar);

                if (validChars.length === currentChar.length && validChars.length > 0) {
                    currentCharacters = validChars;
                    currentCharIndex = 0;
                    loaded = true;
                } else {
                    console.warn(`‚ö†Ô∏è Word "${currentChar}" has unsupported characters. Skipping...`);
                    retryCount++;
                }
            }

            if (!loaded) {
                currentCharData = defaultChars[0];
                currentChar = currentCharData.character;
                currentCharacters = [currentChar];
                currentCharIndex = 0;
            }

            document.getElementById("status").innerText = `üìñ ${currentCharData.pinyin} (${currentCharData.english})`;

            // Set HP based on number of characters
            if (currentCharacters.length === 1) {
                hp = 100;
                maxHP = 100;
            } else if (currentCharacters.length === 2) {
                hp = 300;
                maxHP = 300;
            } else if (currentCharacters.length === 3) {
                hp = 400;
                maxHP = 400;
            }
            updateHP();

            document.getElementById("character-target").innerHTML = "";
            document.getElementById("character-target-1").innerHTML = "";

            // Responsive canvas size based on viewport (width and height)
            let vw = window.innerWidth;
            let vh = window.innerHeight;

            // Calculate a fluid canvasSize based on viewport
            // For 3+ characters, we reduce the scale to make sure everything fits vertically
            let heightLimitMultiplier = currentCharacters.length >= 3 ? 0.28 : 0.35;
            let widthLimitMultiplier = 0.75;

            let canvasSize = Math.min(vw * widthLimitMultiplier, vh * heightLimitMultiplier);

            // Constrain canvasSize to reasonable limits
            if (vw > 768) {
                canvasSize = Math.min(canvasSize, 380);
            } else {
                // Minimum size depends on count: 3+ chars need smaller minimums to fit
                let minSize = currentCharacters.length >= 3 ? 150 : 180;
                canvasSize = Math.max(canvasSize, minSize);
            }

            // Setup character preview and reference
            if (currentCharacters.length === 1) {
                // Single character - show as reference
                const charContainer = document.getElementById("character-target");
                charContainer.style.display = "block";
                charContainer.style.width = canvasSize + "px";
                charContainer.style.height = canvasSize + "px";
                charContainer.style.margin = "15px auto";
                charContainer.style.background = "white";
                charContainer.style.borderRadius = "10px";
                charContainer.style.padding = "0";
                charContainer.style.overflow = "hidden";

                HanziWriter.create('character-target', currentChar, {
                    width: canvasSize,
                    height: canvasSize,
                    showOutline: true,
                    showCharacter: true,
                    drawingWidth: 20
                });
            } else {
                // Multiple characters - show grid
                const gridContainer = document.getElementById("character-target");
                gridContainer.style.display = "flex";
                gridContainer.style.flexWrap = "wrap";
                gridContainer.style.justifyContent = "center";
                gridContainer.style.alignItems = "center";
                gridContainer.style.width = "100%";
                gridContainer.style.height = "auto";
                gridContainer.style.padding = "10px";
                gridContainer.style.gap = "10px";
                gridContainer.style.background = "transparent";
                gridContainer.style.borderRadius = "0";

                const smallCanvasSize = Math.floor(canvasSize * 0.45);
                currentCharacters.forEach((char, index) => {
                    const charDiv = document.createElement('div');
                    charDiv.id = `char-preview-${index}`;
                    charDiv.style.width = smallCanvasSize + 'px';
                    charDiv.style.height = smallCanvasSize + 'px';
                    charDiv.style.background = index === currentCharIndex ? '#ffff99' : 'white';
                    charDiv.style.padding = '5px';
                    charDiv.style.borderRadius = '5px';
                    charDiv.style.border = index === currentCharIndex ? '3px solid #ffcc00' : '1px solid #ccc';
                    gridContainer.appendChild(charDiv);

                    HanziWriter.create(`char-preview-${index}`, char, {
                        width: smallCanvasSize - 10,
                        height: smallCanvasSize - 10,
                        showOutline: true,
                        showCharacter: true,
                        drawingWidth: 8
                    });
                });
            }

            // Create writer for first character (works for both single and multiple)
            createWriterForCurrentChar(canvasSize);
        }

        function startHPDrain() {
            clearInterval(hpInterval);
            hpInterval = setInterval(() => {
                reduceHP(1);
            }, 300);
        }

        function reduceHP(amount) {
            hp -= amount;
            if (hp <= 0) {
                hp = 0;
                gameOver();
            }
            updateHP();
        }

        function updateHP() {
            const hpPercent = (hp / maxHP) * 100;
            document.getElementById("hp-bar").style.width = hpPercent + "%";
            document.getElementById("hp-text").innerText = Math.ceil(hpPercent) + "%";
        }

        function generateBeautifulName() {
            const adjectives = ["Golden", "Emerald", "Mystic", "Azure", "Silent", "Dancing", "Crouching", "Flying", "Crimson", "Radiant", "Zen", "Jade", "Silver", "Imperial", "Wild", "Ocean", "Spirit", "Eternal"];
            const nouns = ["Dragon", "Phoenix", "Panda", "Lotus", "Ink", "Brush", "Mountain", "River", "Storm", "Tiger", "Crane", "Soul", "Warrior", "Shadow", "Cloud", "Bamboo", "Blade", "Moon"];

            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const suffix = Math.random().toString(16).substring(2, 6).toUpperCase();

            return `${adj}_${noun}_${suffix}`;
        }

        function refreshName() {
            document.getElementById("player-name").value = generateBeautifulName();
        }

        function gameOver() {
            clearInterval(hpInterval);
            document.getElementById("status").innerText = "üíÄ Game Over!";

            // Suggest a beautiful name
            refreshName();

            // Show game over overlay
            const overlay = document.getElementById("game-over-screen");
            overlay.classList.remove("hidden");
            overlay.querySelector("#final-score-display span").innerText = score;
        }

        // Removed auto-start: startGame();
    </script>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDi_bKIWk2J4JlV7Hr5FPvGG5uMLX7qZc",
            authDomain: "chinese-writer-14f9a.firebaseapp.com",
            projectId: "chinese-writer-14f9a",
            storageBucket: "chinese-writer-14f9a.firebasestorage.app",
            messagingSenderId: "172568786390",
            appId: "1:172568786390:web:d388025c7289b71bff2077",
            measurementId: "G-67QE12KPHW"
        };

        // Initialize Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed", e);
        }

        // Basic Anti-Cheat: Verification Token
        function generateToken(s, n) {
            return btoa(s + "_" + n + "_" + "H4nzi_S4lt");
        }

        async function submitScore() {
            const name = document.getElementById("player-name").value.trim() || "Anonymous";
            const submitBtn = document.getElementById("submit-btn");

            if (!firebaseConfig.apiKey.startsWith("YOUR")) {
                if (!db) {
                    alert("Firebase not initialized correctly.");
                    return;
                }

                try {
                    submitBtn.disabled = true;
                    submitBtn.innerText = "Submitting...";

                    await addDoc(collection(db, "scores"), {
                        name: name,
                        score: parseInt(score),
                        timestamp: serverTimestamp(),
                        token: generateToken(score, name)
                    });

                    alert("L∆∞u ƒëi·ªÉm th√†nh c√¥ng v√†o b·∫£ng rank ƒë·ªÉ xem nh√©!");
                    location.reload();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    alert("Error submitting score. Please try again.");
                    submitBtn.disabled = false;
                    submitBtn.innerText = "Submit Score";
                }
            } else {
                alert("Firebase not configured. Score was not saved to online leaderboard.");
                location.reload();
            }
        }

        document.getElementById("submit-btn").addEventListener("click", submitScore);
    </script>
</body>

</html>